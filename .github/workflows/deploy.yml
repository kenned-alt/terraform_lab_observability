
name: Terraform Deploy

on:
  push:
    branches: [ "main" ]     # executa ao fazer push na main
  workflow_dispatch:          # permite execução manual

env:
  TF_WORKING_DIR: ./terraform_lab_observability-main  # sua pasta Terraform

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Login no Azure (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}   # JSON com clientId, clientSecret, tenantId, subscriptionId

      # Como seu segredo tem clientSecret, exportamos as variáveis ARM para o provider azurerm
      - name: Exportar variáveis ARM (Client Secret)
        shell: bash
        run: |
          JSON='${{ secrets.AZURE_CREDENTIALS }}'
          echo "ARM_SUBSCRIPTION_ID=$(jq -r '.subscriptionId' <<< \"$JSON\")" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(jq -r '.tenantId' <<< \"$JSON\")" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=$(jq -r '.clientId' <<< \"$JSON\")" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(jq -r '.clientSecret' <<< \"$JSON\")" >> $GITHUB_ENV

      # Se seu backend do Terraform (azurerm) usa Access Key (em vez de RBAC),
      # crie o segredo ARM_ACCESS_KEY no repositório e descomente este passo:
      # - name: Exportar ARM_ACCESS_KEY (para backend, se necessário)
      #   run: echo "ARM_ACCESS_KEY=${{ secrets.ARM_ACCESS_KEY }}" >> $GITHUB_ENV

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.4.0   # sua versão

      - name: Inicializar Terraform
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Validar código
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Plano de mudanças
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -input=false -out=tfplan

      - name: Mostrar plano no log
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform show -no-color tfplan

      - name: Aplicar infraestrutura
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -input=false -auto-approve tfplan
